# SeaweedFS Docker Compose Setup

A complete Docker Compose setup for SeaweedFS - a distributed file system with S3-compatible API, featuring HAProxy rate limiting with authentication and automatic SSL certificate generation for s3 endpoint.

## Overview

This setup provides a fully functional SeaweedFS cluster with:
- **Master Server**: Coordinates the cluster and manages metadata
- **Volume Server**: Handles actual file storage
- **Filer**: Provides file system interface and metadata management
- **S3 Gateway**: S3-compatible API with HTTPS support
- **HAProxy**: Load balancer with HTTP basic authentication and rate limiting

## Architecture

```
Internet → HAProxy (Port 8803) → SeaweedFS Filer (Port 8899)
                ↓
        Authentication & Rate Limiting
                ↓
    SeaweedFS Cluster (Master + Volume + Filer + S3)
```

## Prerequisites

- Docker and Docker Compose installed
- OpenSSL (for certificate generation)
- Linux, macOS, or Windows with MSYS/MinGW

## Repository Structure

```
├── certs/                    # SSL certificates (generated by install.sh)
├── configs/
│   ├── haproxy-entrypoint.sh # HAProxy configuration script
│   └── seaweed-config.sh     # SeaweedFS wrapper script
├── secrets/
│   ├── s3_access_key.txt     # S3 access key (update with your key)
│   └── s3_secret_key.txt     # S3 secret key (update with your key)
├── volumes/                  # Data persistence (created by containers)
├── .env                      # Environment variables (create from .example.env)
├── .example.env              # Environment template
├── .gitignore                # Git ignore rules
├── docker-compose.yml        # Docker Compose configuration
├── install.sh                # Installation script
└── README.md                 # This file
```

## Quick Start

### 1. Clone and Setup

```bash
git clone <your-repo>
cd <repo-directory>
```

### 2. Configure Environment

Copy the example environment file and customize it:

```bash
cp .example.env .env
```

Edit `.env` with your configuration:

```bash
# Authentication credentials
USER=your_username
PASSWORD=your_secure_password

# SSL Certificate subject (adjust for your needs)
CA_SUBJECT="/C=US/ST=State/L=City/O=Organization/OU=Unit/CN=localhost"
```

### 3. Update S3 Credentials

Edit the pre-configured S3 credential files:

```bash
# Update with your desired S3 access credentials
echo "your_s3_access_key" > secrets/s3_access_key.txt
echo "your_s3_secret_key" > secrets/s3_secret_key.txt
```

### 4. Run Installation Script

```bash
chmod +x install.sh
./install.sh
```

## Service Details

### Ports and Access Points

| Service | Internal Port | External Port | Description |
|---------|---------------|---------------|-------------|
| HAProxy | 80 | 8803 | Main entry point with authentication |
| Master | 9333 | 127.0.0.1:9333 | Master server (local only) |
| Volume | 8085 | 127.0.0.1:8085 | Volume server UI (local only) |
| Filer | 8899 | 127.0.0.1:8899 | Filer UI (local only) |
| S3 HTTP | 8333 | 127.0.0.1:8333 | S3 API HTTP (local only) |
| S3 HTTPS | 8334 | 127.0.0.1:8334 | S3 API HTTPS (local only) |

### HAProxy Features

- **Authentication**: HTTP Basic Auth using credentials from `.env`
- **Reverse Proxy**: Routes traffic to SeaweedFS Filer
- **Rate Limiting**: Maximum 10 requests per minute per IP
- **Security**: Prevents unauthorized access to the cluster

### SeaweedFS Components

#### Master Server
- Coordinates the entire cluster
- Manages volume assignments
- Handles replication logic
- Provides cluster status and metrics

#### Volume Server
- Stores actual file data
- Handles read/write operations
- Manages disk space allocation
- Provides storage metrics

#### Filer
- File system metadata management
- Directory structure handling
- File permissions and attributes
- WebDAV support

#### S3 Gateway
- S3-compatible API endpoints
- SSL/TLS encryption support
- Integrates with AWS SDK and tools
- Bucket and object management

## Usage Examples

### Accessing the Web Interface

1. Open your browser and go to `http://localhost:8803`
2. Enter your username and password from the `.env` file
3. You'll be connected to the SeaweedFS Filer interface

## Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `USER` | HAProxy authentication username | Required |
| `PASSWORD` | HAProxy authentication password | Required |
| `CA_SUBJECT` | SSL certificate subject | Required |

### Volume Persistence

Data is persisted in local directories:
- `./volumes/volume/`: File data storage
- `./volumes/filer/`: Metadata storage
- `./certs/`: SSL certificates

### Custom Configuration

To modify SeaweedFS settings:
1. Edit `configs/seaweed-config.sh`
2. Modify service commands in `docker-compose.yml`
3. Restart services: `docker-compose restart`

## Monitoring and Metrics

Access metrics endpoints:
- Master metrics: `http://localhost:9324/metrics`
- Volume metrics: `http://localhost:9325/metrics`
- Filer metrics: `http://localhost:9326/metrics`
- S3 metrics: `http://localhost:9327/metrics`

## Troubleshooting

### Common Issues

1. **Permission Denied**: Ensure proper file permissions on secrets and certificates
2. **Certificate Errors**: Check if certificates were generated correctly in `./certs/`
3. **Authentication Failed**: Verify `.env` file contains correct credentials
4. **Port Conflicts**: Check if ports are already in use

### Logs

View service logs:
```bash
# All services
docker-compose logs

# Specific service
docker-compose logs sfs_master
docker-compose logs haproxy
```

### Health Checks

Check service status:
```bash
docker-compose ps
```

Test S3 connectivity:
```bash
curl -u username:password http://localhost:8803
```

## Security Considerations

- Change default credentials in `.env`
- Use strong passwords for S3 keys
- Consider firewall rules for production
- Regularly update Docker images
- Monitor access logs in HAProxy

## Backup and Recovery

### Backup Data
```bash
# Backup volume data
tar -czf backup-volume-$(date +%Y%m%d).tar.gz volumes/volume/

# Backup filer metadata
tar -czf backup-filer-$(date +%Y%m%d).tar.gz volumes/filer/
```

### Restore Data
```bash
# Stop services
docker-compose down

# Restore data
tar -xzf backup-volume-YYYYMMDD.tar.gz
tar -xzf backup-filer-YYYYMMDD.tar.gz

# Start services
docker-compose up -d
```

## License

This setup is provided as-is. SeaweedFS is licensed under Apache License 2.0.

## Support

For SeaweedFS specific issues, visit: https://github.com/seaweedfs/seaweedfs

For setup issues, check:
- Docker Compose logs
- HAProxy configuration
- Network connectivity
- File permissions